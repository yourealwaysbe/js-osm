<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
    
    <div id="load-box">
        <div>
            <input type="file" id="file-input"/>
            <button id="load-button">Load File</button>
            <input type="text" id="url-input"/>
            <button id="load-url-button">Load URL</button>
            <button id="clear-db-button">Clear Database</button>
        </div>
        <div>
            <p>
                PBF Files available from 
               <a href="http://download.geofabrik.de/">Geofabrik</a>
               or
               <a href="http://extract.bbbike.org/">BBBike</a>.
               Files of less than 10mb seem to work ok, larger may fail.  Works
               in Firefox.  Doesn't work in Chromium.  Load URL will probably fail
               because of the single origin policy.
            </p>
        </div>
    </div>
    
    <canvas width=800 height=500 id="map-canvas"></canvas>

    <div id="map-controls">
        <button id="zoom-in">Zoom In</button>
        <button id="zoom-out">Zoom Out</button>
        <button id="move-north">N</button>
        <button id="move-south">S</button>
        <button id="move-west">W</button>
        <button id="move-east">E</button>
        <span id="stats">Stats...</span>
    </div>
<!--        
    <iframe id="debuggerId" class="debuggerContainer"
            src="IDBExplorer/IDBExplorer.html?name=maps" 
            height=800 width=800>
    </iframe>
-->    
    <script type="text/javascript" src="jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="osm-read-pbf.js"> </script>
    <script type="text/javascript" src="map.js"> </script>
    <script type="text/javascript" src="mapdb.js"> </script>
    <script type="text/javascript" src="maprender.js"> </script>
    <script>
        var ZOOM_FACTOR = 0.75;

        $(document).ready(function () {
            mapdb.open(function () {
                var $loadButton = $("#load-button");
                var $loadURLButton = $("#load-url-button");
                var $canvas = $("#map-canvas");
                var canvas = $canvas.get(0);
                var $stats = $("#stats");

                var render = new MapRender(canvas, mapdb);

                var updateStats = function () {
                    $stats.html("Lat: " + render.getLat().toFixed(4) + ", " +
                                "Lon: " + render.getLon().toFixed(4) + ", " +
                                "Dpp: " + render.getDpp());
                }

                var loadURI = function (uri, button) {
                    var oldHtml = button.html();

                    button.html("Loading...");
                    if (!!uri) {
                        mapdb.loadPbf(uri, function () {
                            button.html(oldHtml);
                            render.render();
                        });
                    } else {
                        alert("No source specified.");
                        button.html(loadHtml);
                    }
                }

                $loadButton.click(function (e) {
                    loadURI($("#file-input").val(), $loadButton);
                });

                $loadURLButton.click(function (e) {
                    loadURI($("#url-input").val(), $loadURLButton);
                });

                $("#clear-db-button").click(function (e) {
                    mapdb.clear();
                });

                $("#zoom-in").click(function (e) {
                    render.zoom(ZOOM_FACTOR);
                    updateStats();
                });

                $("#zoom-out").click(function (e) {
                    render.zoom(1 / ZOOM_FACTOR);
                    updateStats();
                });

                $("#move-north").click(function (e) {
                    render.move(0, 100);
                    updateStats();
                });

                $("#move-south").click(function (e) {
                    render.move(0, -100);
                    updateStats();
                });

                $("#move-west").click(function (e) {
                    render.move(-100, 0);
                    updateStats();
                });

                $("#move-east").click(function (e) {
                    render.move(100, 0);
                    updateStats();
                });

                $canvas.click(function (e) {
                    var offX = e.pageX - canvas.offsetLeft;
                    var offY = e.pageY - canvas.offsetTop;
                    render.center(offX, offY);
                    updateStats();
                });

                render.render();
                updateStats();
            });
        });
    </script>
</body>
</html>
